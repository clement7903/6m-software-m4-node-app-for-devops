version: 2.1
orbs:
  node: circleci/node@5

jobs:
  build:
    # Install Node dependencies & cache them
    executor: node/default
    steps:
      - checkout
      - restore_cache:
          keys:
            - node-modules-{{ checksum "package-lock.json" }}
      - node/install-packages:
          pkg-manager: npm
      - save_cache:
          paths:
            - ./node_modules
          key: node-modules-{{ checksum "package-lock.json" }}

  test:
    # Run Jest tests
    executor: node/default
    environment:
      JEST_JUNIT_OUTPUT_DIR: ./test-results/
    steps:
      - checkout
      - restore_cache:
          keys:
            - node-modules-{{ checksum "package-lock.json" }}
      - run:
          name: Run tests
          command: npm run test --ci --runInBand --reporters=default --reporters=jest-junit
      - store_test_results:
          path: ./test-results/
      - store_artifacts:
          path: ./test-results/

  deploy:
    # Deployment Steps
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Login to Docker Hub
          command: |
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - run:
          name: Build and Push Docker Image
          command: |
            docker build -t container-assignment:latest .
            docker tag container-assignment:latest clement7903/container-assignment:latest
            docker push clement7903/container-assignment:latest

workflows:
  build-and-test:
    jobs:
      - build
      - test:
          requires:
            - build
      - deploy:
          requires:
            - test
          context: docker-hub-credentials
