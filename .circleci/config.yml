version: 2.1
orbs:
  node: circleci/node@5
  docker: circleci/docker@2.1.4
  heroku: circleci/heroku@2.0.0

jobs:
  build:
    # Install Node dependencies & cache them
    executor: node/default
    steps:
      - checkout
      - restore_cache:
          keys:
            - node-modules-{{ checksum "package-lock.json" }}
      - node/install-packages:
          pkg-manager: npm
      - save_cache:
          paths:
            - ./node_modules
          key: node-modules-{{ checksum "package-lock.json" }}

  test:
    # Run Jest tests
    executor: node/default
    environment:
      JEST_JUNIT_OUTPUT_DIR: ./test-results/
    steps:
      - checkout
      - restore_cache:
          keys:
            - node-modules-{{ checksum "package-lock.json" }}
      - run:
          name: Run tests
          command: |
            echo "Running tests"
            npm run test --ci --runInBand --reporters=default --reporters=jest-junit
      - store_test_results:
          path: ./test-results/
      - store_artifacts:
          path: ./test-results/

  publish:
    # Build and Push Docker Image
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Print Version Tag
          command: echo "Version Tag << pipeline.git.tag >>"
      - checkout
      - setup_remote_docker
      - run:
          name: Login to Docker Hub
          command: |
            echo "Logging in to Docker Hub"
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
      - run:
          name: Build and Push Docker Image
          command: |
            echo "Building and Pushing Docker Image with tag << pipeline.git.tag >>"
            docker build -t container-assignment:<< pipeline.git.tag >> .
            docker tag container-assignment:<< pipeline.git.tag >> clement7903/container-assignment:<< pipeline.git.tag >>
            docker push clement7903/container-assignment:<< pipeline.git.tag >>

  deploy:
    docker:
      - image: cimg/node:16.10
    steps:
      - setup_remote_docker
      - heroku/install
      - checkout
      - run:
          name: Heroku Container Push
          command: |
            heroku container:login
            heroku stack:set container -a clement-su-devops
            heroku container:push web -a clement-su-devops
            heroku container:release web -a clement-su-devops

workflows:
  build-test-publish:
    jobs:
      - build:
          filters:
            branches:
              only:
                - main
                - release
            tags:
              only: /^v\d+\.\d+\.\d+$/
      - test:
          requires:
            - build
          filters:
            branches:
              only:
                - main
                - release
            tags:
              only: /^v\d+\.\d+\.\d+$/
      - publish:
          requires:
            - test
          context: docker-hub-credentials
          filters:
            branches:
              only:
                - release
            tags:
              only: /^v\d+\.\d+\.\d+$/
      - deploy:
          requires:
            - publish
          filters:
            branches:
              only:
                - release
            tags:
              only: /^v\d+\.\d+\.\d+$/
